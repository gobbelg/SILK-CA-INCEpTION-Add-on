////
Parts of this document are generated by swagger2markup.
It can be run by calling

    mvn swagger2markup:convertSwagger2markup

from the inception-imls-external module. The output file then is

    inception-imls-external/target/asciidoc/external_recommender_api.adoc

When making changes to the API, just copy the stuff from there over to this document starting from [[_external_recommender_api_paths]]
////

= External recommender

[[_external_recommender_api_overview]]
== Overview
This section describes the External Recommender API for {product-name}. An external recommender is a
classifier whose functionality is exposed via a HTTP web service. It can predict annotations for
given documents and optionally be trained on new data. This document describes the endpoints a web
service needs to expose so it can be used with {product-name}. The documents that are exchanged are in
form of a UIMA CAS. For sending, they have to be serialized to CAS XMI. For receiving, it has to be
deserialized back. There are two main libraries available that manage CAS handling, one is the
link:https://uima.apache.org[Apache UIMA Java SDK], the other one link:https://github.com/dkpro/dkpro-cassis#dkpro-cassis[dkpro-cassis] (Python).

[[_external_recommender_api_paths]]
== API Endpoints

[[_external_recommender_api_predictcas]]
=== Predict annotations for a single document
....
POST /predict
....


==== Description
Sends a CAS together with information about the layer and feature to predict to the external recommender. The external recommender then returns the CAS annotated with predictions.


==== Parameters

[options="header", cols=".^2,.^3,.^9,.^4"]
|===
|Type|Name|Description|Schema
|**Body**|**body** +
__required__|Document CAS for which annotations will be predicted|<<_external_recommender_api_predictrequest,PredictRequest>>
|===


==== Responses

[options="header", cols=".^2,.^14,.^4"]
|===
|HTTP Code|Description|Schema
|**200**|Successful prediction|<<_external_recommender_api_predictresponse,PredictResponse>>
|===


==== Consumes

* `application/json`


==== Produces

* `application/json`


==== Tags

* predict


==== Example HTTP request

===== Request path
----
/predict
----


===== Request body
[source,json]
----
{
  "metadata" : {
    "layer" : "de.tudarmstadt.ukp.dkpro.core.api.ner.type.NamedEntity",
    "feature" : "value",
    "projectId" : 1337,
    "anchoringMode" : "tokens",
    "crossSentence" : false
  },
  "document" : {
    "xmi" : "<?xml version=\"1.0\" encoding=\"UTF-8\"?> <xmi:XMI xmlns:tcas=\"http:///uima/tcas.ecore\" xmlns:xmi=\"http://www.omg.org/XMI\" xmlns:cas=\"http:///uima/cas.ecore\" xmlns:cassis=\"http:///cassis.ecore\" xmi:version=\"2.0\"> <cas:NULL xmi:id=\"0\"/> <tcas:DocumentAnnotation xmi:id=\"8\" sofa=\"1\" begin=\"0\" end=\"47\" language=\"x-unspecified\"/> <cas:Sofa xmi:id=\"1\" sofaNum=\"1\" sofaID=\"mySofa\" mimeType=\"text/plain\" sofaString=\"Joe waited for the train . The train was late .\"/> <cas:View sofa=\"1\" members=\"8\"/> </xmi:XMI>",
    "documentId" : 42,
    "userId" : "testuser"
  },
  "typeSystem" : "<?xml version=\"1.0\" encoding=\"UTF-8\"?> <typeSystemDescription xmlns=\"http://uima.apache.org/resourceSpecifier\"> <types> <typeDescription> <name>uima.tcas.DocumentAnnotation</name> <description/> <supertypeName>uima.tcas.Annotation</supertypeName> <features> <featureDescription> <name>language</name> <description/> <rangeTypeName>uima.cas.String</rangeTypeName> </featureDescription> </features> </typeDescription> </types> </typeSystemDescription>"
}
----


==== Example HTTP response

===== Response 200
[source,json]
----
{
  "document" : "<?xml version=\"1.0\" encoding=\"UTF-8\"?> <xmi:XMI xmlns:tcas=\"http:///uima/tcas.ecore\" xmlns:xmi=\"http://www.omg.org/XMI\" xmlns:cas=\"http:///uima/cas.ecore\" xmlns:cassis=\"http:///cassis.ecore\" xmi:version=\"2.0\"> <cas:NULL xmi:id=\"0\"/> <tcas:DocumentAnnotation xmi:id=\"8\" sofa=\"1\" begin=\"0\" end=\"47\" language=\"x-unspecified\"/> <cas:Sofa xmi:id=\"1\" sofaNum=\"1\" sofaID=\"mySofa\" mimeType=\"text/plain\" sofaString=\"Joe waited for the train . The train was late .\"/> <cas:View sofa=\"1\" members=\"8\"/> </xmi:XMI>"
}
----


[[_external_recommender_api_trainrecommender]]
=== Train recommender on a set of documents
....
POST /train
....


==== Description
Sends a list of CASses to the external recommender for training. No response body is expected.


==== Parameters

[options="header", cols=".^2,.^3,.^9,.^4"]
|===
|Type|Name|Description|Schema
|**Body**|**body** +
__required__|List of documents CAS whose annotations will be used for training|<<_external_recommender_api_train,Train>>
|===


==== Responses

[options="header", cols=".^2,.^14,.^4"]
|===
|HTTP Code|Description|Schema
|**204**|Successful training|No Content
|**429**|Too many training requests have been sent, the sender should wait a while until the next request|No Content
|===


==== Consumes

* `application/json`


==== Tags

* train


==== Example HTTP request

===== Request path
----
/train
----


===== Request body
[source,json]
----
{
  "metadata" : {
    "layer" : "de.tudarmstadt.ukp.dkpro.core.api.ner.type.NamedEntity",
    "feature" : "value",
    "projectId" : 1337,
    "anchoringMode" : "tokens",
    "crossSentence" : false
  },
  "documents" : [ {
    "xmi" : "<?xml version=\"1.0\" encoding=\"UTF-8\"?> <xmi:XMI xmlns:tcas=\"http:///uima/tcas.ecore\" xmlns:xmi=\"http://www.omg.org/XMI\" xmlns:cas=\"http:///uima/cas.ecore\" xmlns:cassis=\"http:///cassis.ecore\" xmi:version=\"2.0\"> <cas:NULL xmi:id=\"0\"/> <tcas:DocumentAnnotation xmi:id=\"8\" sofa=\"1\" begin=\"0\" end=\"47\" language=\"x-unspecified\"/> <cas:Sofa xmi:id=\"1\" sofaNum=\"1\" sofaID=\"mySofa\" mimeType=\"text/plain\" sofaString=\"Joe waited for the train . The train was late .\"/> <cas:View sofa=\"1\" members=\"8\"/> </xmi:XMI>",
    "documentId" : 42,
    "userId" : "testuser"
  } ],
  "typeSystem" : "<?xml version=\"1.0\" encoding=\"UTF-8\"?> <typeSystemDescription xmlns=\"http://uima.apache.org/resourceSpecifier\"> <types> <typeDescription> <name>uima.tcas.DocumentAnnotation</name> <description/> <supertypeName>uima.tcas.Annotation</supertypeName> <features> <featureDescription> <name>language</name> <description/> <rangeTypeName>uima.cas.String</rangeTypeName> </featureDescription> </features> </typeDescription> </types> </typeSystemDescription>"
}
----




[[_external_recommender_api_definitions]]
== Definitions

[[_external_recommender_api_document]]
=== Document

[options="header", cols=".^3,.^11,.^4"]
|===
|Name|Description|Schema
|**documentId** +
__optional__|Identifier for this document. It is unique in the context of the project. +
**Example** : `42`|integer
|**userId** +
__optional__|Identifier for the user for which recommendations should be made. +
**Example** : `"testuser"`|string
|**xmi** +
__optional__|CAS as XMI +
**Example** : `"<?xml version=\"1.0\" encoding=\"UTF-8\"?> <xmi:XMI xmlns:tcas=\"http:///uima/tcas.ecore\" xmlns:xmi=\"http://www.omg.org/XMI\" xmlns:cas=\"http:///uima/cas.ecore\" xmlns:cassis=\"http:///cassis.ecore\" xmi:version=\"2.0\"> <cas:NULL xmi:id=\"0\"/> <tcas:DocumentAnnotation xmi:id=\"8\" sofa=\"1\" begin=\"0\" end=\"47\" language=\"x-unspecified\"/> <cas:Sofa xmi:id=\"1\" sofaNum=\"1\" sofaID=\"mySofa\" mimeType=\"text/plain\" sofaString=\"Joe waited for the train . The train was late .\"/> <cas:View sofa=\"1\" members=\"8\"/> </xmi:XMI>"`|string
|===


[[_external_recommender_api_metadata]]
=== Metadata

[options="header", cols=".^3,.^11,.^4"]
|===
|Name|Description|Schema
|**anchoringMode** +
__required__|Describes how annotations are anchored to tokens. Is one of 'characters', 'singleToken', 'tokens', 'sentences'. +
**Example** : `"tokens"`|string
|**crossSentence** +
__required__|True if the project supports cross-sentence annotations, else False +
**Example** : `false`|boolean
|**feature** +
__required__|Feature of the layer which should be predicted +
**Example** : `"value"`|string
|**layer** +
__required__|Layer which should be predicted +
**Example** : `"de.tudarmstadt.ukp.dkpro.core.api.ner.type.NamedEntity"`|string
|**projectId** +
__required__|The id of the project to which the document(s) belong. +
**Example** : `1337`|integer
|===


[[_external_recommender_api_predictrequest]]
=== PredictRequest

[options="header", cols=".^3,.^11,.^4"]
|===
|Name|Description|Schema
|**document** +
__required__|**Example** : `"<<_external_recommender_api_document>>"`|<<_external_recommender_api_document,Document>>
|**metadata** +
__required__|**Example** : `"<<_external_recommender_api_metadata>>"`|<<_external_recommender_api_metadata,Metadata>>
|**typeSystem** +
__required__|Type system XML of the CAS +
**Example** : `"<?xml version=\"1.0\" encoding=\"UTF-8\"?> <typeSystemDescription xmlns=\"http://uima.apache.org/resourceSpecifier\"> <types> <typeDescription> <name>uima.tcas.DocumentAnnotation</name> <description/> <supertypeName>uima.tcas.Annotation</supertypeName> <features> <featureDescription> <name>language</name> <description/> <rangeTypeName>uima.cas.String</rangeTypeName> </featureDescription> </features> </typeDescription> </types> </typeSystemDescription>"`|string
|===


[[_external_recommender_api_predictresponse]]
=== PredictResponse

[options="header", cols=".^3,.^11,.^4"]
|===
|Name|Description|Schema
|**document** +
__required__|CAS with annotations from the external recommender as XMI +
**Example** : `"<?xml version=\"1.0\" encoding=\"UTF-8\"?> <xmi:XMI xmlns:tcas=\"http:///uima/tcas.ecore\" xmlns:xmi=\"http://www.omg.org/XMI\" xmlns:cas=\"http:///uima/cas.ecore\" xmlns:cassis=\"http:///cassis.ecore\" xmi:version=\"2.0\"> <cas:NULL xmi:id=\"0\"/> <tcas:DocumentAnnotation xmi:id=\"8\" sofa=\"1\" begin=\"0\" end=\"47\" language=\"x-unspecified\"/> <cas:Sofa xmi:id=\"1\" sofaNum=\"1\" sofaID=\"mySofa\" mimeType=\"text/plain\" sofaString=\"Joe waited for the train . The train was late .\"/> <cas:View sofa=\"1\" members=\"8\"/> </xmi:XMI>"`|string
|===


[[_external_recommender_api_train]]
=== Train

[options="header", cols=".^3,.^11,.^4"]
|===
|Name|Description|Schema
|**documents** +
__required__|CAS as XMI +
**Example** : `[ "<<_external_recommender_api_document>>" ]`|< <<_external_recommender_api_document,Document>> > array
|**metadata** +
__required__|**Example** : `"<<_external_recommender_api_metadata>>"`|<<_external_recommender_api_metadata,Metadata>>
|**typeSystem** +
__required__|Type system XML of the CAS +
**Example** : `"<?xml version=\"1.0\" encoding=\"UTF-8\"?> <typeSystemDescription xmlns=\"http://uima.apache.org/resourceSpecifier\"> <types> <typeDescription> <name>uima.tcas.DocumentAnnotation</name> <description/> <supertypeName>uima.tcas.Annotation</supertypeName> <features> <featureDescription> <name>language</name> <description/> <rangeTypeName>uima.cas.String</rangeTypeName> </featureDescription> </features> </typeDescription> </types> </typeSystemDescription>"`|string
|===

== Encoding annotation suggestions

This section explains how annotation suggestions can be encoded in the response to a `predict` call.

Note that a recommender can only produce suggestions for one feature on one layer. The name of the layer and feature are contained in the request to the `predict` call and only suggestions generated for that specific layer and feature will be processed by {product-name} when the call returns.

For the purpose of producing annotation suggestions, this specific layer is extended with additional features that can be set. Some of these features start with the name of the feature (we use `<FEATURE_NAME>` as a placeholder for the actual feature name below) to be predicted and then add a suffix:

* `inception_internal_predicted`: this boolean feature indicates that an annotation was added by the external recommender. It allows the system to distinguish between annotations that already existed in the document and annotations that the recommender has created. Only annotations where this flag is set to `true` will be processed by {product-name}.
* `<FEATURE_NAME>`: this feature takes the label that the external recommender assigns.
* `<FEATURE_NAME>_score` (optional): this floating-point (double) feature can be used to indicate the score assigned to a predicted label.
* `<FEATURE_NAME>_score_explanation` (optional): this string feature can be used to provide an explanation for the score. This explanation is shown on the annotation page when the user inspects a particular suggestion (note that not all editors may support displaying explanations).
* `<FEATURE_NAME>_auto_accept` (optional): this feature can be set to `on-first-access` to force-accept an annotation into a document when an annotator accesses a document for the first time. This should only be used in conjunction with non-trainable recommenders and with the option **Wait for suggestions from non-trainable recommenders when opening document** in the recommender project settings. Thus, when an annotator opens a document for the first time, the system would wait for recommendations by non-trainable (pre-trained) recommenders and then directly accept any of the suggestions that the recommender has marked to uto-accept on-first-access. When the annotator resets a document via the action bar, this procedure is also followed. This provides a convenient way of "pre-annotating" documents with the help of external recommenders. Note though that an annotator has to actually open a document in order for this process to trigger.
